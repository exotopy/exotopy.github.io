<!DOCTYPE html>
<html>
<head>
    <title>Tree of Life Tarot Study</title>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, setDoc, updateDoc } 
            from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBOTt7ZC9BB1xr0qgxt2-u6N_A0zrpXtXo",
            authDomain: "tarot-notes-ce74f.firebaseapp.com",
            projectId: "tarot-notes-ce74f",
            storageBucket: "tarot-notes-ce74f.firebasestorage.app",
            messagingSenderId: "102510585363",
            appId: "1:102510585363:web:e14dc1bb94284898f181e6",
            measurementId: "G-L27KGY14ZC"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        window.db = db;
        window.firestore = { doc, getDoc, setDoc, updateDoc, collection };
    </script>

    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }

        #title {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            min-height: 30px;
        }

        .container {
            display: flex;
            height: calc(100vh - 100px);
        }


        .panel {
            width: 33.33%;
            padding: 20px;
            box-sizing: border-box;
        }

        .center-panel {
            position: relative;
        }

        .tree-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .sephirah-group {
            position: absolute;
            transform: translate(-50%, -50%);
            cursor: pointer;
            z-index: 2;
        }

        .sephirah {
            width: 60px;
            height: 60px;
            border: 4px solid black;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 12px;
            padding: 4px;
            cursor: pointer;
            transition: all 0s ease;
        }

        .sephirah.selected {
    background: #ffffe2; 
    border-color: #000000; 
    box-shadow: 0 0 10px rgba(255, 234, 41, 0.699);
     border: 5px dashed black;
            border-radius: 50%;
            font-weight: bold;

}

        .path-label {
            position: absolute;
            font-size: 12px;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2px;
            cursor: pointer;
            z-index: 2;
        }

        svg {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        line {
            cursor: pointer;
        }

        textarea, input {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }

        textarea {
    height: 200px;
    resize: vertical;
    min-height: 100px;
    max-height: 80vh;
}

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .hidden {
            display: none;
        }

        .image-container {
            margin-bottom: 15px;
        }

        .card-preview {
            max-width: 200px;
            max-height: 300px;
            margin: 10px 0;
            border: 1px solid #ccc;
            display: none;
        }

        .card-field {
    margin-bottom: 20px;
    border: 1px solid #ccc;
    padding: 10px;
    border-radius: 4px;
}

.upload-area {
    width: 100%;
    text-align: center;
}

.card-preview {
    width: 200px;
    height: 340px;
    object-fit: contain;
    border: 1px solid #ccc;
    background: #f5f5f5;
    display: none;
}
        .gallery-controls {
    display: flex;
    align-items: center;
    gap: 10px;
    width: 100%;
}

.gallery-btn {
    padding: 5px 10px;
    background: #f0f0f0;
    border: 1px solid #ccc;
    border-radius: 4px;
    cursor: pointer;
}

.gallery-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.gallery-display {
    position: relative;
}

.image-counter {
    position: absolute;
    bottom: 10px;
    right: 10px;
    background: rgba(0,0,0,0.5);
    color: white;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 12px;
}
line {
    cursor: pointer;
    transition: all 0.3s ease;
}

line.selected {
    stroke: #000000; 
    stroke-width: 6; 
    stroke-dasharray: 8;
}

.path-label.selected {
    background: #ffffe2;
    font-weight: bold;
    padding: 4px;
    border-radius: 4px;
}
.gallery-display {
    position: relative;
}

.image-controls {
    position: absolute;
    top: 0;
    right: 0;
    display: flex;
    gap: 5px;
    padding: 5px;
    background: rgba(0,0,0,0.5);
    border-radius: 4px;
}

.image-control-btn {
    padding: 2px 5px;
    background: #f0f0f0;
    border: 1px solid #ccc;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
}

.image-control-btn:hover {
    background: #e0e0e0;
}
    </style>
</head>
<body>
    <div id="title"></div>
    <div class="container">
        <!-- Left Panel -->
        <div class="panel" id="leftPanel">
            <div id="pathInputs" class="hidden">
                <div class="card-field">
                    <label>Card Images</label>
                    <div class="image-container">
                        <div class="gallery-controls">
                            <button type="button" class="gallery-btn prev">←</button>
                            <div class="gallery-display">
                                <img id="cardImageDisplay" class="card-preview" alt="Card Image">
                                <div class="image-controls">
                                    <button type="button" class="image-control-btn move-left">←</button>
                                    <button type="button" class="image-control-btn move-right">→</button>
                                    <button type="button" class="image-control-btn delete">×</button>
                                </div>
                                <div class="image-counter">1 / 1</div>
                            </div>
                            <button type="button" class="gallery-btn next">→</button>
                        </div>
                        <div class="upload-area">
                            <input type="file" accept="image/*" id="cardImage" multiple>
                        </div>
                    </div>
                </div>
                <input type="text" placeholder="Card Name">
                <input type="text" placeholder="Hebrew Character">
                <label>Correspondences</label>
                <textarea></textarea>
            </div>
            <div id="sephirahInputs" class="hidden">
                <div class="card-field">
                    <label>Sephirah Images</label>
                    <div class="image-container">
                        <div class="gallery-controls">
                            <button type="button" class="gallery-btn prev">←</button>
                            <div class="gallery-display">
                                <img id="sephirahImageDisplay" class="card-preview" alt="Sephirah Image">
                                <div class="image-controls">
                                    <button type="button" class="image-control-btn move-left">←</button>
                                    <button type="button" class="image-control-btn move-right">→</button>
                                    <button type="button" class="image-control-btn delete">×</button>
                                </div>
                                <div class="image-counter">1 / 1</div>
                            </div>
                            <button type="button" class="gallery-btn next">→</button>
                        </div>
                        <div class="upload-area">
                            <input type="file" accept="image/*" id="sephirahImage" multiple>
                        </div>
                    </div>
                </div>
                <input type="text" placeholder="Title/Name">
                <input type="text" placeholder="Hebrew Name">
                <label>Wands</label>
<textarea class="wands"></textarea>
<label>Pentacles</label>
<textarea class="pentacles"></textarea>
            </div>
        </div>

        <!-- Center Panel -->
        <div class="panel center-panel">
            <div class="tree-container" id="treeContainer">
                <svg>
                    <!-- Paths will be added here -->
                </svg>
                <!-- Sephirot will be added here -->
            </div>
        </div>

        <!-- Right Panel -->
        <div class="panel" id="rightPanel">
            <div id="pathNotes" class="hidden">
                <label>Notes</label>
                <textarea placeholder="Enter notes..."></textarea>
            </div>
            <div id="sephirahAdditionalNotes" class="hidden">
                <label>Swords</label>
            <textarea class="swords"></textarea>
            <label>Cups</label>
            <textarea class="cups"></textarea>
            </div>
        </div>
    </div>
    <script>
        let currentSephirah = null;
        let currentPath = null;

        const sephirot = {
            kether: { name: 'Keter', x: 50, y: 5 },
            binah: { name: 'Binah', x: 25, y: 20 },
            chokhmah: { name: 'Chokhmah', x: 75, y: 20 },
            geburah: { name: 'Geburah', x: 25, y: 40 },
            chesed: { name: 'Chesed', x: 75, y: 40 },
            tiphareth: { name: 'Tiphareth', x: 50, y: 50 },
            hod: { name: 'Hod', x: 25, y: 65 },
            netzach: { name: 'Netzach', x: 75, y: 65 },
            yesod: { name: 'Yesod', x: 50, y: 80 },
            malkuth: { name: 'Malkuth', x: 50, y: 95 }
        };

        const paths = [
            { start: 'kether', end: 'binah', card: '1 Magician', labelOffset: { x: -3, y: -1 } },
            { start: 'kether', end: 'chokhmah', card: '0 Fool', labelOffset: { x: 3, y: -1 } },
            { start: 'kether', end: 'tiphareth', card: '2 High Priestess', labelOffset: { x: 0, y: -2 } },
            { start: 'binah', end: 'chokhmah', card: '3 Empress', labelOffset: { x: 0, y: 0 } },
            { start: 'binah', end: 'geburah', card: '7 Chariot', labelOffset: { x: -3, y: -1 } },
            { start: 'binah', end: 'tiphareth', card: '6 Lovers', labelOffset: { x: -1, y: -1 } },
            { start: 'chokhmah', end: 'chesed', card: '5 Hierophant', labelOffset: { x: 3, y: -1 } },
            { start: 'chokhmah', end: 'tiphareth', card: '4 Emperor', labelOffset: { x: 2, y: -1 } },
            { start: 'geburah', end: 'chesed', card: '11 Strength', labelOffset: { x: 0, y: 0 } },
            { start: 'geburah', end: 'tiphareth', card: '8 Justice', labelOffset: { x: -3, y: 0 } },
            { start: 'geburah', end: 'hod', card: '12 Hanged Man', labelOffset: { x: -3, y: 0 } },
            { start: 'chesed', end: 'tiphareth', card: '9 Hermit', labelOffset: { x: 3, y: 0 } },
            { start: 'chesed', end: 'netzach', card: '10 Wheel', labelOffset: { x: 3, y: 0 } },
            { start: 'tiphareth', end: 'netzach', card: '13 Death', labelOffset: { x: 3, y: 0 } },
            { start: 'tiphareth', end: 'hod', card: '15 Devil', labelOffset: { x: -3, y: 0 } },
            { start: 'tiphareth', end: 'yesod', card: '14 Temperance', labelOffset: { x: 0, y: 4 } },
            { start: 'hod', end: 'netzach', card: '16 The Tower', labelOffset: { x: 0, y: 0 } },
            { start: 'hod', end: 'yesod', card: '19 The Sun', labelOffset: { x: -3, y: 0 } },
            { start: 'netzach', end: 'yesod', card: '17 The Star', labelOffset: { x: 3, y: 0 } },
            { start: 'hod', end: 'malkuth', card: '20 Judgement', labelOffset: { x: -3, y: 0 } },
            { start: 'yesod', end: 'malkuth', card: '21 The World', labelOffset: { x: 0, y: 0 } },
            { start: 'netzach', end: 'malkuth', card: '18 The Moon', labelOffset: { x: 3, y: 0 } }
        ];

        function createTree() {
            const container = document.getElementById('treeContainer');
            const svg = container.querySelector('svg');

            paths.forEach(path => {
                const start = sephirot[path.start];
                const end = sephirot[path.end];
                
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', start.x + '%');
                line.setAttribute('y1', start.y + '%');
                line.setAttribute('x2', end.x + '%');
                line.setAttribute('y2', end.y + '%');
                line.setAttribute('stroke', 'black');
                line.setAttribute('stroke-width', '4');
                
                line.addEventListener('click', () => selectPath(path));
                svg.appendChild(line);

                const label = document.createElement('div');
                label.className = 'path-label';
                label.textContent = path.card;
                label.style.left = `${(start.x + end.x) / 2 + path.labelOffset.x}%`;
                label.style.top = `${(start.y + end.y) / 2 + path.labelOffset.y}%`;
                label.addEventListener('click', () => selectPath(path));
                container.appendChild(label);
            });

            Object.entries(sephirot).forEach(([key, data]) => {
                const group = document.createElement('div');
                group.className = 'sephirah-group';
                group.style.left = `${data.x}%`;
                group.style.top = `${data.y}%`;

                const sephirah = document.createElement('div');
                sephirah.className = 'sephirah';
                sephirah.textContent = data.name;

                group.appendChild(sephirah);
                group.addEventListener('click', () => selectSephirah(key));
                container.appendChild(group);
            });
        }

        async function selectPath(path) {
    // Remove selected class from all sephirot
    document.querySelectorAll('.sephirah').forEach(el => {
        el.classList.remove('selected');
    });

    // Remove selected class from all paths
    document.querySelectorAll('line').forEach(el => {
        el.classList.remove('selected');
    });
    document.querySelectorAll('.path-label').forEach(el => {
        el.classList.remove('selected');
    });

    // Add selected class to clicked path
    const start = sephirot[path.start];
    const end = sephirot[path.end];
    const line = document.querySelector(`line[x1="${start.x}%"][y1="${start.y}%"][x2="${end.x}%"][y2="${end.y}%"]`);
    line.classList.add('selected');

    // Add selected class to associated label
    const label = Array.from(document.querySelectorAll('.path-label'))
        .find(el => el.textContent === path.card);
    if (label) {
        label.classList.add('selected');
    }

    currentPath = path;
    currentSephirah = null;
    
    document.getElementById('title').textContent = path.card;
    document.getElementById('pathInputs').classList.remove('hidden');
    document.getElementById('pathNotes').classList.remove('hidden');
    document.getElementById('sephirahInputs').classList.add('hidden');
    document.getElementById('sephirahAdditionalNotes').classList.add('hidden');

    try {
        const docRef = window.firestore.doc(window.db, 'pathNotes', path.card);
        const docSnap = await window.firestore.getDoc(docRef);
        
        if (docSnap.exists()) {
            const data = docSnap.data();
            
            // Load image if it exists
            const imageDisplay = document.getElementById('cardImageDisplay');
            const prevBtn = document.querySelector('#pathInputs .gallery-btn.prev');
            const nextBtn = document.querySelector('#pathInputs .gallery-btn.next');
            const counter = document.querySelector('#pathInputs .image-counter');

            if (data.images && data.images.length) {
                currentImageIndex = 0;
                imageDisplay.src = data.images[currentImageIndex].data;
                imageDisplay.style.display = 'block';
                counter.textContent = `1 / ${data.images.length}`;
                counter.style.display = 'block';
                
                prevBtn.disabled = true;  // First image, so disable prev
                nextBtn.disabled = data.images.length === 1;  // Disable next if only one image
            } else {
                imageDisplay.style.display = 'none';
                counter.style.display = 'none';
                prevBtn.disabled = true;
                nextBtn.disabled = true;
            }

            // Load other fields
            document.querySelector('#pathNotes textarea').value = data.notes || '';
            document.querySelector('#pathInputs input[placeholder="Card Name"]').value = data.cardName || '';
            document.querySelector('#pathInputs input[placeholder="Hebrew Character"]').value = data.hebrewCharacter || '';
            document.querySelector('#pathInputs textarea').value = data.correspondences || '';
        } else {
            document.getElementById('cardImageDisplay').style.display = 'none';
            document.querySelector('#pathNotes textarea').value = '';
            document.querySelector('#pathInputs input[placeholder="Card Name"]').value = '';
            document.querySelector('#pathInputs input[placeholder="Hebrew Character"]').value = '';
            document.querySelector('#pathInputs textarea').value = '';
        }
    } catch (error) {
        console.error('Error loading notes:', error);
    }
}

async function selectSephirah(key) {
    // Remove selected class from all paths
document.querySelectorAll('line').forEach(el => {
    el.classList.remove('selected');
});
document.querySelectorAll('.path-label').forEach(el => {
    el.classList.remove('selected');
});
    // Remove selected class from all sephirot
    document.querySelectorAll('.sephirah').forEach(el => {
        el.classList.remove('selected');
    });
    
    // Add selected class to clicked sephirah
    document.querySelector(`.sephirah-group[style*="left: ${sephirot[key].x}%"][style*="top: ${sephirot[key].y}%"] .sephirah`)
        .classList.add('selected');

    currentSephirah = key;
    currentPath = null;
    
    document.getElementById('title').textContent = sephirot[key].name;
    document.getElementById('pathInputs').classList.add('hidden');
    document.getElementById('pathNotes').classList.add('hidden');
    document.getElementById('sephirahInputs').classList.remove('hidden');
    document.getElementById('sephirahAdditionalNotes').classList.remove('hidden');

    try {
        const docRef = window.firestore.doc(window.db, 'sephirahNotes', key);
        const docSnap = await window.firestore.getDoc(docRef);
        
        if (docSnap.exists()) {
            const data = docSnap.data();
            
            // Load images if they exist
            const imageDisplay = document.getElementById('sephirahImageDisplay');
            const prevBtn = document.querySelector('#sephirahInputs .gallery-btn.prev');
            const nextBtn = document.querySelector('#sephirahInputs .gallery-btn.next');
            const counter = document.querySelector('#sephirahInputs .image-counter');

            if (data.images && data.images.length) {
                currentImageIndex = 0;
                imageDisplay.src = data.images[currentImageIndex].data;
                imageDisplay.style.display = 'block';
                counter.textContent = `1 / ${data.images.length}`;
                counter.style.display = 'block';
                
                prevBtn.disabled = true;
                nextBtn.disabled = data.images.length === 1;
            } else {
                imageDisplay.style.display = 'none';
                counter.style.display = 'none';
                prevBtn.disabled = true;
                nextBtn.disabled = true;
            }

            // Load the new fields
            document.querySelector('#sephirahInputs input[placeholder="Title/Name"]').value = data.title || '';
            document.querySelector('#sephirahInputs input[placeholder="Hebrew Name"]').value = data.hebrewName || '';
            document.querySelector('#sephirahInputs textarea.wands').value = data.wands || '';
            document.querySelector('#sephirahInputs textarea.pentacles').value = data.pentacles || '';
            document.querySelector('#sephirahAdditionalNotes textarea.swords').value = data.swords || '';
            document.querySelector('#sephirahAdditionalNotes textarea.cups').value = data.cups || '';
        } else {
            // Clear all fields if no data exists
            document.getElementById('sephirahImageDisplay').style.display = 'none';
            document.querySelector('#sephirahInputs input[placeholder="Title/Name"]').value = '';
            document.querySelector('#sephirahInputs input[placeholder="Hebrew Name"]').value = '';
            document.querySelector('#sephirahInputs textarea.wands').value = '';
            document.querySelector('#sephirahInputs textarea.pentacles').value = '';
            document.querySelector('#sephirahAdditionalNotes textarea.swords').value = '';
            document.querySelector('#sephirahAdditionalNotes textarea.cups').value = '';
        }
    } catch (error) {
        console.error('Error loading notes:', error);
    }
}

        async function saveSephirahNotes() {
    if (!currentSephirah) return;
    
    try {
        const docRef = window.firestore.doc(window.db, 'sephirahNotes', currentSephirah);
        const docSnap = await window.firestore.getDoc(docRef);
        
        const newData = {
    title: document.querySelector('#sephirahInputs input[placeholder="Title/Name"]').value,
    hebrewName: document.querySelector('#sephirahInputs input[placeholder="Hebrew Name"]').value,
    wands: document.querySelector('#sephirahInputs textarea.wands').value,
    pentacles: document.querySelector('#sephirahInputs textarea.pentacles').value,
    swords: document.querySelector('#sephirahAdditionalNotes textarea.swords').value,
    cups: document.querySelector('#sephirahAdditionalNotes textarea.cups').value,
    lastModified: new Date()
};

        // Preserve existing images
        if (docSnap.exists() && docSnap.data().images) {
            newData.images = docSnap.data().images;
        }

        await window.firestore.setDoc(docRef, newData);
    } catch (error) {
        console.error('Error saving notes:', error);
        alert('Failed to save notes. Please check your connection.');
    }
}
        async function savePathNotes() {
    if (!currentPath) return;
    
    try {
        const docRef = window.firestore.doc(window.db, 'pathNotes', currentPath.card);
        const docSnap = await window.firestore.getDoc(docRef);
        
        const newData = {
            notes: document.querySelector('#pathNotes textarea').value,
            cardName: document.querySelector('#pathInputs input[placeholder="Card Name"]').value,
            hebrewCharacter: document.querySelector('#pathInputs input[placeholder="Hebrew Character"]').value,
            correspondences: document.querySelector('#pathInputs textarea').value,
            lastModified: new Date()
        };

        // Preserve existing images if they exist
        if (docSnap.exists() && docSnap.data().images) {
            newData.images = docSnap.data().images;
        }

        await window.firestore.setDoc(docRef, newData);
    } catch (error) {
        console.error('Error saving notes:', error);
        alert('Failed to save notes. Please check your connection.');
    }
}

async function deleteCurrentImage(isPath = true) {
    const docRef = isPath 
        ? window.firestore.doc(window.db, 'pathNotes', currentPath.card)
        : window.firestore.doc(window.db, 'sephirahNotes', currentSephirah);

    try {
        const docSnap = await window.firestore.getDoc(docRef);
        if (docSnap.exists() && docSnap.data().images) {
            const images = docSnap.data().images;
            images.splice(currentImageIndex, 1);
            
            await window.firestore.setDoc(docRef, { images }, { merge: true });
            
            if (images.length === 0) {
                currentImageIndex = 0;
                if (isPath) {
                    updateGallery([]);
                } else {
                    updateSephirahGallery([]);
                }
            } else {
                currentImageIndex = Math.min(currentImageIndex, images.length - 1);
                if (isPath) {
                    updateGallery(images);
                } else {
                    updateSephirahGallery(images);
                }
            }
        }
    } catch (error) {
        console.error('Error deleting image:', error);
        alert('Failed to delete image. Please try again.');
    }
}

async function moveImage(direction, isPath = true) {
    const docRef = isPath 
        ? window.firestore.doc(window.db, 'pathNotes', currentPath.card)
        : window.firestore.doc(window.db, 'sephirahNotes', currentSephirah);

    try {
        const docSnap = await window.firestore.getDoc(docRef);
        if (docSnap.exists() && docSnap.data().images) {
            const images = docSnap.data().images;
            const newIndex = currentImageIndex + direction;
            
            if (newIndex >= 0 && newIndex < images.length) {
                // Swap images
                [images[currentImageIndex], images[newIndex]] = [images[newIndex], images[currentImageIndex]];
                await window.firestore.setDoc(docRef, { images }, { merge: true });
                
                currentImageIndex = newIndex;
                if (isPath) {
                    updateGallery(images);
                } else {
                    updateSephirahGallery(images);
                }
            }
        }
    } catch (error) {
        console.error('Error moving image:', error);
        alert('Failed to move image. Please try again.');
    }
}

        document.getElementById('cardImage').addEventListener('change', async function(event) {
    const files = event.target.files;
    if (!files.length || !currentPath) return;

    try {
        const docRef = window.firestore.doc(window.db, 'pathNotes', currentPath.card);
        const docSnap = await window.firestore.getDoc(docRef);
        let existingImages = [];
        
        if (docSnap.exists() && docSnap.data().images) {
            existingImages = docSnap.data().images;
        }

        for (let file of files) {
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const img = new Image();
                    img.onload = async () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        const maxDimension = 800;
                        
                        if (width > maxDimension || height > maxDimension) {
                            if (width > height) {
                                height = (height / width) * maxDimension;
                                width = maxDimension;
                            } else {
                                width = (width / height) * maxDimension;
                                height = maxDimension;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        const compressedData = canvas.toDataURL('image/jpeg', 0.6);

                        const imageData = {
                            data: compressedData,
                            name: file.name,
                            type: 'image/jpeg',
                            lastModified: new Date().toISOString()
                        };

                        existingImages.push(imageData);

                        await window.firestore.setDoc(docRef, {
                            images: existingImages
                        }, { merge: true });

                        updateGallery(existingImages);
                    };
                    img.src = e.target.result;
                } catch (error) {
                    console.error('Error processing image:', error);
                }
            };
            reader.readAsDataURL(file);
        }
    } catch (error) {
        console.error('Error saving images:', error);
        alert('Failed to save images: ' + error.message);
    }
});

let currentImageIndex = 0;

function updateGallery(images) {
    const imageDisplay = document.getElementById('cardImageDisplay');
    const counter = document.querySelector('.image-counter');
    const prevBtn = document.querySelector('.gallery-btn.prev');
    const nextBtn = document.querySelector('.gallery-btn.next');
    

    if (!images || !images.length) {
        imageDisplay.style.display = 'none';
        counter.style.display = 'none';
        prevBtn.disabled = true;
        nextBtn.disabled = true;
        return;
    }

    imageDisplay.src = images[currentImageIndex].data;
    imageDisplay.style.display = 'block';
    counter.textContent = `${currentImageIndex + 1} / ${images.length}`;
    counter.style.display = 'block';
    
    prevBtn.disabled = currentImageIndex === 0;
    nextBtn.disabled = currentImageIndex === images.length - 1;
    const moveLeftBtn = document.querySelector('#pathInputs .image-control-btn.move-left');
    const moveRightBtn = document.querySelector('#pathInputs .image-control-btn.move-right');
    if (moveLeftBtn && moveRightBtn) {
        moveLeftBtn.disabled = currentImageIndex === 0;
        moveRightBtn.disabled = currentImageIndex === images.length - 1;
    }

    
}

// Add event listeners for gallery navigation
document.querySelector('.gallery-btn.prev').addEventListener('click', () => {
    const docRef = window.firestore.doc(window.db, 'pathNotes', currentPath.card);
    window.firestore.getDoc(docRef).then(docSnap => {
        if (docSnap.exists() && docSnap.data().images) {
            const images = docSnap.data().images;
            if (currentImageIndex > 0) {
                currentImageIndex--;
                updateGallery(images);
            }
        }
    });
});

document.querySelector('.gallery-btn.next').addEventListener('click', () => {
    const docRef = window.firestore.doc(window.db, 'pathNotes', currentPath.card);
    window.firestore.getDoc(docRef).then(docSnap => {
        if (docSnap.exists() && docSnap.data().images) {
            const images = docSnap.data().images;
            if (currentImageIndex < images.length - 1) {
                currentImageIndex++;
                updateGallery(images);
            }
        }
    });
});

// Add event listener for Sephirah image uploads
document.getElementById('sephirahImage').addEventListener('change', async function(event) {
    const files = event.target.files;
    if (!files.length || !currentSephirah) return;

    try {
        const docRef = window.firestore.doc(window.db, 'sephirahNotes', currentSephirah);
        const docSnap = await window.firestore.getDoc(docRef);
        let existingImages = [];
        
        if (docSnap.exists() && docSnap.data().images) {
            existingImages = docSnap.data().images;
        }

        for (let file of files) {
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const img = new Image();
                    img.onload = async () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        const maxDimension = 800;
                        
                        // Resize image if needed
                        if (width > maxDimension || height > maxDimension) {
                            if (width > height) {
                                height = (height / width) * maxDimension;
                                width = maxDimension;
                            } else {
                                width = (width / height) * maxDimension;
                                height = maxDimension;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        const compressedData = canvas.toDataURL('image/jpeg', 0.6);

                        const imageData = {
                            data: compressedData,
                            name: file.name,
                            type: 'image/jpeg',
                            lastModified: new Date().toISOString()
                        };

                        existingImages.push(imageData);

                        await window.firestore.setDoc(docRef, {
                            images: existingImages
                        }, { merge: true });

                        updateSephirahGallery(existingImages);
                    };
                    img.src = e.target.result;
                } catch (error) {
                    console.error('Error processing image:', error);
                }
            };
            reader.readAsDataURL(file);
        }
    } catch (error) {
        console.error('Error saving images:', error);
        alert('Failed to save images: ' + error.message);
    }
});

// Function to update the Sephirah image gallery display
function updateSephirahGallery(images) {
    const imageDisplay = document.getElementById('sephirahImageDisplay');
    const counter = document.querySelector('#sephirahInputs .image-counter');
    const prevBtn = document.querySelector('#sephirahInputs .gallery-btn.prev');
    const nextBtn = document.querySelector('#sephirahInputs .gallery-btn.next');

    if (!images || !images.length) {
        imageDisplay.style.display = 'none';
        counter.style.display = 'none';
        prevBtn.disabled = true;
        nextBtn.disabled = true;
        return;
    }

    imageDisplay.src = images[currentImageIndex].data;
    imageDisplay.style.display = 'block';
    counter.textContent = `${currentImageIndex + 1} / ${images.length}`;
    counter.style.display = 'block';
    
    prevBtn.disabled = currentImageIndex === 0;
    nextBtn.disabled = currentImageIndex === images.length - 1;
    const moveLeftBtn = document.querySelector('#sephirahInputs .image-control-btn.move-left');
    const moveRightBtn = document.querySelector('#sephirahInputs .image-control-btn.move-right');
    if (moveLeftBtn && moveRightBtn) {
        moveLeftBtn.disabled = currentImageIndex === 0;
        moveRightBtn.disabled = currentImageIndex === images.length - 1;
    }
}

// Add event listeners for Sephirah gallery navigation
document.querySelector('#sephirahInputs .gallery-btn.prev').addEventListener('click', () => {
    const docRef = window.firestore.doc(window.db, 'sephirahNotes', currentSephirah);
    window.firestore.getDoc(docRef).then(docSnap => {
        if (docSnap.exists() && docSnap.data().images) {
            const images = docSnap.data().images;
            if (currentImageIndex > 0) {
                currentImageIndex--;
                updateSephirahGallery(images);
            }
        }
    });
});

document.querySelector('#sephirahInputs .gallery-btn.next').addEventListener('click', () => {
    const docRef = window.firestore.doc(window.db, 'sephirahNotes', currentSephirah);
    window.firestore.getDoc(docRef).then(docSnap => {
        if (docSnap.exists() && docSnap.data().images) {
            const images = docSnap.data().images;
            if (currentImageIndex < images.length - 1) {
                currentImageIndex++;
                updateSephirahGallery(images);
            }
        }
    });
});
// For paths
document.querySelector('#pathInputs .image-control-btn.delete').addEventListener('click', () => {
    if (confirm('Are you sure you want to delete this image?')) {
        deleteCurrentImage(true);
    }
});

document.querySelector('#pathInputs .image-control-btn.move-left').addEventListener('click', () => {
    moveImage(-1, true);
});

document.querySelector('#pathInputs .image-control-btn.move-right').addEventListener('click', () => {
    moveImage(1, true);
});

// For sephirot
document.querySelector('#sephirahInputs .image-control-btn.delete').addEventListener('click', () => {
    if (confirm('Are you sure you want to delete this image?')) {
        deleteCurrentImage(false);
    }
});

document.querySelector('#sephirahInputs .image-control-btn.move-left').addEventListener('click', () => {
    moveImage(-1, false);
});

document.querySelector('#sephirahInputs .image-control-btn.move-right').addEventListener('click', () => {
    moveImage(1, false);
});
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            createTree();
            setupAutoSave();
        });

        // Clear selection when clicking background
        document.querySelector('.container').addEventListener('click', (e) => {
    if (e.target.className === 'container' || e.target.className === 'panel') {
        // Remove selected class from all sephirot
        document.querySelectorAll('.sephirah').forEach(el => {
            el.classList.remove('selected');
        });
        
        // Remove selected class from all paths
        document.querySelectorAll('line').forEach(el => {
            el.classList.remove('selected');
        });
        document.querySelectorAll('.path-label').forEach(el => {
            el.classList.remove('selected');
        });

        document.getElementById('title').textContent = '';
        document.getElementById('pathInputs').classList.add('hidden');
        document.getElementById('pathNotes').classList.add('hidden');
        document.getElementById('sephirahInputs').classList.add('hidden');
        document.getElementById('sephirahAdditionalNotes').classList.add('hidden');
        currentPath = null;
        currentSephirah = null;
    }
});

        // Auto-save setup
        function setupAutoSave() {
    // Handle all textareas
    const textareas = document.querySelectorAll('textarea');
    textareas.forEach(textarea => {
        let saveTimeout;
        textarea.addEventListener('input', () => {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                if (currentPath) {
                    savePathNotes();
                } else if (currentSephirah) {
                    saveSephirahNotes();
                }
            }, 1000);
        });
    });

    // Handle all text inputs in both pathInputs and sephirahInputs
    const inputs = document.querySelectorAll('#pathInputs input[type="text"], #sephirahInputs input[type="text"]');
    inputs.forEach(input => {
        let saveTimeout;
        input.addEventListener('input', () => {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                if (currentPath) {
                    savePathNotes();
                } else if (currentSephirah) {
                    saveSephirahNotes();
                }
            }, 1000);
        });
    });
}
    </script>
</body>
</html>
